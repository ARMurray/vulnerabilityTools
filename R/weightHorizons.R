#' Weight SSURGO Horizon data into mapunits
#'
#' Create a a flat file that takes values from the SSURGO chorizon table and
#' weighs them by what percent of a component each horizon composes and also what percent of a mapunit each component makes up.
#'
#' @param x a SSURGO list which is returned by running the `get_ssurgo` function from the fedData package
#' @param horizonVar A variable from the 'chorizon' SSURGO table. A list can be found here: https://www.nrcs.usda.gov/wps/PA_NRCSConsumption/download?cid=stelprdb1241114&ext=pdf Make sure to substitute '.' (periods) for '_' (underscores) in the column names.
#'
#' @return A simple features multi-polygon layer which contains a columns called 'weightedMeanVar' which will show the weighted variable you specified for each mapunit.
#' @export
#' @examples
#' library(USAboundaries)
#' library(sf)
#' library(tidyverse)
#' library(FedData)
#' ok <- us_states(resolution = "low")%>%   # Download all state boundaries
#' filter(name == "Oklahoma")%>%   # Filter to Oklahoma
#'   st_transform(crs = 32614) # Project to UTM 14N so distance units are in meters
#'
#' okgrid <- st_make_grid(ok,cellsize = 20000,    # 20,000 m cell size
#'                        square = FALSE)%>% # Returns sfc_POLYGON
#'   st_as_sf()
#' okgrid$ID <- paste0("pt_",rownames(okgrid))
#' colnames(okgrid) <- c("geometry","ID")
#'  st_geometry(okgrid) <- "geometry"

#' sa <- okgrid[365,]%>%
#'    mutate(ID = "Ada")

#' ada <- as_Spatial(sa)
#' ssurgo <- get_ssurgo(ada, label = "Ada")
#' weighted <- weightHorizons(ssurgo, "ksat.r")
#'
#' plot(weighted["muVar"], main = "Weighted ksat")

weightHorizons <- function(x,horizonVar){

  # Create the spatial mukey layer
  mapunit <- sf::st_as_sf(x$spatial)%>% # Convert from sp to sf
    dplyr::mutate(mukey = as.factor(MUKEY))%>%  # create lower case column as factor
    dplyr::group_by(mukey)%>%
    summarise()%>%    # Make it multi-polygons to avoid issues with duplicate mukeys
    dplyr::select(mukey)

  # Create the component table
  component <- x$tabular$component%>%
    dplyr::mutate(mukey = as.factor(mukey))%>%
    dplyr::right_join(mapunit)%>%
    dplyr::mutate(cokey = as.factor(cokey))

  # Create Horizon Table
  horizon <- x$tabular$chorizon%>%
    dplyr::mutate(cokey = as.factor(cokey))%>%
    dplyr::right_join(component)%>%
    dplyr::select(mukey,cokey,chkey,comppct.r,hzthk.r,horizonVar)

  colnames(horizon) <- c("mukey","cokey","chkey","comppct.r","hzthk.r","var")

  horizon%>%
    dplyr::mutate(key = paste0(mukey,cokey))%>%  # make a unique key using mukey & cokey
    dplyr::group_by(key)%>%   # Group by key
    dplyr::mutate(thickness = sum(hzthk.r), # Calculate the total thickness of each component
                  horWeight = var*(hzthk.r/thickness), # Calculate the weighted values by horizon within each component
                  compVar = sum(horWeight), # Add up the weighted horizons
         compPct = comppct.r/100)%>% # Calculate the per cent of the mapunit that each component makes up
    dplyr::ungroup()%>% # ungroup
    dplyr::select(mukey,compVar,compPct)%>%  # select variables
    dplyr::distinct()%>%  #drop duplicate rows
    dplyr::group_by(mukey)%>%
    dplyr::mutate(sumPcts = sum(compPct, na.rm = TRUE))%>%  # Determine sum of component areas (all components should theoretically add up to 1 in a mukey but this may not always be true)
    dplyr::ungroup()%>%
    dplyr::mutate(compWeight = compVar * (compPct / sumPcts))%>%
    dplyr::group_by(mukey)%>%
    dplyr::mutate(muVar = sum(compWeight, na.rm = TRUE))%>%
    dplyr::ungroup()%>%
    dplyr::select(mukey,muVar)%>%
    dplyr::distinct()%>%
    dplyr::mutate(muVar = ifelse(muVar == 0, NA,muVar))%>%
    dplyr::right_join(mapunit)%>%
    sf::st_as_sf()
}
